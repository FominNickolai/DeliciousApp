//
//  Extentions.swift
//  Delicious
//
//  Created by Fomin Nickolai on 11/22/16.
//  Copyright Â© 2016 Fomin Nickolai. All rights reserved.
//

import UIKit
import  AVFoundation

//MARK: -  Device Check
let iPad = UIUserInterfaceIdiom.pad
let iPhone = UIUserInterfaceIdiom.phone

let imageCache = NSCache<NSString, UIImage>()

extension UIDevice {
    static var type: UIUserInterfaceIdiom
    { return UIDevice.current.userInterfaceIdiom }
}

extension Array where Element: Equatable {
    
    mutating func remove(object: Element) {
        if let index = index(of: object) {
            remove(at: index)
        }
    }
}

extension UIImage {
    
    func maskWithColor(color: UIColor) -> UIImage? {
        let maskImage = cgImage!
        
        let width = size.width
        let height = size.height
        let bounds = CGRect(x: 0, y: 0, width: width, height: height)
        
        let colorSpace = CGColorSpaceCreateDeviceRGB()
        let bitmapInfo = CGBitmapInfo(rawValue: CGImageAlphaInfo.premultipliedLast.rawValue)
        let context = CGContext(data: nil, width: Int(width), height: Int(height), bitsPerComponent: 8, bytesPerRow: 0, space: colorSpace, bitmapInfo: bitmapInfo.rawValue)!
        
        context.clip(to: bounds, mask: maskImage)
        context.setFillColor(color.cgColor)
        context.fill(bounds)
        
        if let cgImage = context.makeImage() {
            let coloredImage = UIImage(cgImage: cgImage)
            return coloredImage
        } else {
            return nil
        }
    }
}

extension UIView {
    func roundCorners(corners:UIRectCorner, radius: CGFloat) {
        let path = UIBezierPath(roundedRect: self.bounds, byRoundingCorners: corners, cornerRadii: CGSize(width: radius, height: radius))
        let mask = CAShapeLayer()
        mask.path = path.cgPath
        self.layer.mask = mask
    }
}

extension UIView
{
    func searchVisualEffectsSubview() -> UIVisualEffectView?
    {
        if let visualEffectView = self as? UIVisualEffectView
        {
            return visualEffectView
        }
        else
        {
            for subview in subviews
            {
                if let found = subview.searchVisualEffectsSubview()
                {
                    return found
                }
            }
        }
        
        return nil
    }
}

extension UIImageView {
    
    func loadImageUsingCacheWithUrlString(urlString: String, completion: (() -> ())?) {
        
        self.image = nil
        
        //check cache for image first
        if let cacehdImage = imageCache.object(forKey: urlString as NSString) {
            self.image = cacehdImage
            if let comletionToRun = completion {
                comletionToRun()
            }
            return
        }
        
        //otherwise fire off a new download
        let url = URL(string: urlString)
        URLSession.shared.dataTask(with: url!, completionHandler: { (data, response, error) in
            if error != nil {
                return
            }
            DispatchQueue.main.async(execute: {
                if let downloadedImage = UIImage(data: data!) {
                    imageCache.setObject(downloadedImage, forKey: urlString as NSString)
                    self.alpha = 0
                    self.image = downloadedImage
                    UIView.animate(withDuration: 1.0, animations: {
                        self.alpha = 1
                    })
                }
                if let comletionToRun = completion {
                    comletionToRun()
                }
            })
            
        }).resume()
        
    }
    
}

extension UIColor {
    
    convenience init(r: CGFloat, g: CGFloat, b: CGFloat) {
        self.init(red: r/255, green: g/255, blue: b/255, alpha: 1)
    }
    
}

extension AVPlayer {
    
    var isPlaying: Bool {
        return ((rate != 0) && (error == nil))
    }
}
